<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Äî –ö–ü</title>
  <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body class="auth-body">
  <div class="auth-card modern big">
    <div class="logo">üîÆ</div>
    <h1>–ö–æ–ª–ª–µ–∫—Ç–∏–≤–Ω–æ–µ –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ</h1>
    <p class="muted">–°–æ–∑–¥–∞–π—Ç–µ –≥–µ—Ä–æ—è ‚Äî –∏ —Å—Ä–∞–∑—É –≤ –ª–æ–∫–∞—Ü–∏—é</p>

    <div class="tabs">
      <button class="tab" data-tab="login">–í—Ö–æ–¥</button>
      <button class="tab active" data-tab="register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>

    <!-- LOGIN -->
    <div class="panel" id="panel-login">
      <div class="row">
        <label class="lbl">–ò–º—è –∏–≥—Ä–æ–∫–∞</label>
        <input id="l-username" placeholder="–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞" autocomplete="username">
        <div class="hint" id="l-u-err"></div>
      </div>
      <div class="row pw">
        <label class="lbl">–ü–∞—Ä–æ–ª—å</label>
        <div class="pw-wrap">
          <input id="l-password" type="password" placeholder="–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" autocomplete="current-password">
          <button class="pw-eye" type="button" data-for="l-password">üëÅ</button>
        </div>
        <div class="hint" id="l-p-err"></div>
      </div>
      <div class="actions">
        <button id="btn-login" class="primary">–í–æ–π—Ç–∏</button>
      </div>
    </div>

    <!-- REGISTER with curated palettes & hairstyles -->
    <div class="panel active" id="panel-register">
      <div class="creator">
        <div class="creator-left">
          <div class="row">
            <span class="lbl">–ü–æ–ª</span>
            <label><input type="radio" name="gender" value="male"> –ú—É–∂—Å–∫–æ–π</label>
            <label><input type="radio" name="gender" value="female"> –ñ–µ–Ω—Å–∫–∏–π</label>
            <label><input type="radio" name="gender" value="other" checked> –ù–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è</label>
          </div>

          <div class="row grid2">
            <div>
              <label class="lbl">–ò–º—è –∏–≥—Ä–æ–∫–∞</label>
              <input id="r-username" placeholder="–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞" autocomplete="username">
              <div class="hint" id="r-u-err"></div>
            </div>
            <div class="pw">
              <label class="lbl">–ü–∞—Ä–æ–ª—å</label>
              <div class="pw-wrap">
                <input id="r-password" type="password" placeholder="–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" autocomplete="new-password">
                <button class="pw-eye" type="button" data-for="r-password">üëÅ</button>
              </div>
              <div class="hint" id="r-p-err"></div>
            </div>
          </div>

          <div class="row">
            <div class="hint-row">
              <label class="lbl">–¶–≤–µ—Ç –∫–æ–∂–∏</label>
              <span class="small-muted">–Ω–∞—Ç—É—Ä–∞–ª—å–Ω–∞—è –ø–∞–ª–∏—Ç—Ä–∞</span>
            </div>
            <div id="skin-sw" class="swatch-row"></div>
          </div>

          <div class="row">
            <div class="hint-row">
              <label class="lbl">–¶–≤–µ—Ç –≥–ª–∞–∑</label>
              <span class="small-muted">—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏</span>
            </div>
            <div id="eyes-sw" class="swatch-row"></div>
          </div>

          <div class="row">
            <div class="hint-row">
              <label class="lbl">–¶–≤–µ—Ç –≤–æ–ª–æ—Å</label>
              <span class="small-muted">–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞</span>
            </div>
            <div id="hair-sw" class="swatch-row"></div>
          </div>

          <div class="row">
            <label class="lbl">–ü—Ä–∏—á—ë—Å–∫–∞</label>
            <div id="styles-wrap" class="select-inline"></div>
          </div>

          <div class="row">
            <div class="hint-row">
              <label class="lbl">–≠–º–æ—Ü–∏—è</label>
              <span class="small-muted">—Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</span>
            </div>
            <div id="emotion-sw" class="emotion-row"></div>
          </div>

          <div class="actions">
            <button id="btn-register" class="primary">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
          </div>
        </div>

        <div class="creator-right">
          <canvas id="preview" width="260" height="260"></canvas>
          <div class="muted small">–ü—Ä–µ–≤—å—é –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</div>
        </div>
      </div>
    </div>

    <p id="err" class="error"></p>
  </div>

<script>
// Helpers
async function api(url, method="GET", body=null){
  const opt={method};
  if(body instanceof FormData){ opt.body=body; }
  else if(body){ opt.headers={"Content-Type":"application/json"}; opt.body=JSON.stringify(body); }
  const r=await fetch(url,opt); return r.json();
}
function switchTab(id){
  document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
  document.querySelectorAll('.panel').forEach(p=>p.classList.toggle('active', p.id==='panel-'+id));
  document.getElementById('err').textContent='';
}
document.querySelectorAll('.tab').forEach(b=>b.addEventListener('click',()=>switchTab(b.dataset.tab)));
document.querySelectorAll('.pw-eye').forEach(btn=>btn.addEventListener('click',()=>{
  const id=btn.getAttribute('data-for'); const el=document.getElementById(id);
  el.type = (el.type==='password'?'text':'password');
}));

function genderValue(){ const el=[...document.querySelectorAll('input[name="gender"]')].find(e=>e.checked); return el?el.value:"other"; }
function validateUser(name){ return (name||'').trim().length>=3; }
function validatePass(p){ return (p||'').length>=6; }

// Palettes
const SKINS=['#f7d7ba','#f1c7a3','#d39a70','#bb8656','#9c613f'];
const EYES=['#2b4c7e','#5c3b8c','#2f6b3c','#1e1e1e','#6b3f2f'];
const HAIRS=['#1e1e1e','#3a2a1c','#6b4f2f','#a37d58','#c9a873','#df8e44'];
const EMOTIONS=[
  {value:'smile',label:'–£–ª—ã–±–∫–∞',icon:'üôÇ'},
  {value:'neutral',label:'–°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ',icon:'üòê'},
  {value:'frown',label:'–°–µ—Ä—å—ë–∑–Ω—ã–π',icon:'üò†'},
  {value:'surprised',label:'–£–¥–∏–≤–ª–µ–Ω–∏–µ',icon:'üòØ'},
  {value:'sleepy',label:'–°–æ–Ω–Ω—ã–π',icon:'üò¥'}
];

// Hairstyles catalog by gender
const STYLES = {
  male: ["short","fade","buzz","undercut","mohawk","curly","afro","ponytail"],
  female: ["pixie","bob","long","curly","bun","braids","afro","ponytail"],
  other: ["short","pixie","bob","long","curly","afro","braids","mohawk","ponytail"]
};

// State
let state = {
  skin: SKINS[1],
  hair: HAIRS[0],
  eyes: EYES[0],
  style: "short",
  emotion: "smile"
};
try{
  const stored=JSON.parse(localStorage.getItem('cp_appearance')||'{}');
  if(stored.skin && SKINS.includes(stored.skin)) state.skin=stored.skin;
  if(stored.hair && HAIRS.includes(stored.hair)) state.hair=stored.hair;
  if(stored.eyes && EYES.includes(stored.eyes)) state.eyes=stored.eyes;
  if(stored.style && Object.values(STYLES).some(list=>list.includes(stored.style))) state.style=stored.style;
  if(stored.emotion && EMOTIONS.some(e=>e.value===stored.emotion)) state.emotion=stored.emotion;
}catch(e){}

// Build swatches
function makeSwatches(id, arr, cls){
  const box=document.getElementById(id); box.innerHTML="";
  const current = id==='skin-sw'?state.skin:(id==='eyes-sw'?state.eyes:state.hair);
  let selectedEl=null;
  arr.forEach((val)=>{
    const d=document.createElement('div'); d.className='swatch '+(cls||'');
    d.style.background=val; d.dataset.val=val; d.dataset.selected=0;
    d.addEventListener('click',()=>{
      box.querySelectorAll('.swatch').forEach(s=>s.dataset.selected=0);
      d.dataset.selected=1;
      if(id==='skin-sw') state.skin=val;
      if(id==='eyes-sw') state.eyes=val;
      if(id==='hair-sw') state.hair=val;
      redrawPreview();
    });
    if(val===current){ selectedEl=d; }
    box.appendChild(d);
  });
  const target=selectedEl || box.querySelector('.swatch');
  if(target){
    target.dataset.selected=1;
    const val=target.dataset.val;
    if(id==='skin-sw') state.skin=val;
    if(id==='eyes-sw') state.eyes=val;
    if(id==='hair-sw') state.hair=val;
  }
}
function makeStyles(){
  const g=genderValue();
  const list=STYLES[g]||STYLES.other;
  const box=document.getElementById('styles-wrap'); box.innerHTML="";
  const preferred = list.includes(state.style)?state.style:list[0];
  state.style = preferred;
  list.forEach((name)=>{
    const b=document.createElement('button'); b.type='button'; b.className='badge'; b.textContent=hairLabel(name);
    b.dataset.val=name;
    b.addEventListener('click',()=>{
      box.querySelectorAll('.badge').forEach(x=>x.dataset.selected=0);
      b.dataset.selected=1; state.style=name; redrawPreview();
    });
    if(name===preferred) b.dataset.selected=1;
    box.appendChild(b);
  });
}
function makeEmotions(){
  const box=document.getElementById('emotion-sw'); if(!box) return;
  box.innerHTML="";
  const current=state.emotion;
  EMOTIONS.forEach(em=>{
    const btn=document.createElement('button');
    btn.type='button';
    btn.className='emotion-btn';
    btn.innerHTML=`<span class="emo-icon">${em.icon}</span><span>${em.label}</span>`;
    btn.dataset.val=em.value;
    btn.addEventListener('click',()=>{
      state.emotion=em.value;
      box.querySelectorAll('.emotion-btn').forEach(b=>b.dataset.selected=0);
      btn.dataset.selected=1;
      redrawPreview();
    });
    if(em.value===current) btn.dataset.selected=1;
    box.appendChild(btn);
  });
}
['male','female','other'].forEach(v=>{
  document.querySelector('input[name="gender"][value="'+v+'"]').addEventListener('change',()=>{ makeStyles(); makeEmotions(); redrawPreview(); });
});

// Preview drawing
const pv=document.getElementById('preview'), pctx=pv.getContext('2d');
function drawShadow(ctx, cx, cy){
  ctx.save();
  ctx.fillStyle='rgba(12,16,32,0.32)';
  ctx.beginPath();
  ctx.ellipse(cx, cy, 88, 22, 0, 0, Math.PI*2);
  ctx.fill();
  ctx.restore();
}
function hairLabel(style){
  const map={short:"–ö–æ—Ä–æ—Ç–∫–∞—è",fade:"–§–µ–π–¥",buzz:"–Å–∂–∏–∫",undercut:"–ê–Ω–¥–µ—Ä–∫–∞—Ç",mohawk:"–ò—Ä–æ–∫–µ–∑",
             curly:"–ö—É–¥—Ä–∏",afro:"–ê—Ñ—Ä–æ",ponytail:"–•–≤–æ—Å—Ç",pixie:"–ü–∏–∫—Å–∏",bob:"–ö–∞—Ä–µ",long:"–î–ª–∏–Ω–Ω—ã–µ",
             bun:"–ü—É—á–æ–∫",braids:"–ö–æ—Å—ã"};
  return map[style]||style;
}
function drawHair(ctx, style, color, cx, top){
  ctx.fillStyle=color;
  if(style==="short"){ ctx.fillRect(cx-46, top-6, 92, 24); }
  else if(style==="fade"){ ctx.fillRect(cx-46, top, 92, 18); ctx.clearRect(cx-46, top+14, 92, 6); }
  else if(style==="buzz"){ ctx.fillRect(cx-46, top+4, 92, 12); }
  else if(style==="undercut"){ ctx.fillRect(cx-46, top-4, 92, 26); ctx.clearRect(cx-46, top+18, 92, 12); }
  else if(style==="mohawk"){ ctx.fillRect(cx-8, top-12, 16, 40); }
  else if(style==="curly"){ for(let i=0;i<12;i++){ ctx.beginPath(); ctx.arc(cx-48+i*8, top+10+(i%2?0:6), 8, 0, Math.PI*2); ctx.fill(); } }
  else if(style==="afro"){ ctx.beginPath(); ctx.arc(cx, top+18, 48, 0, Math.PI*2); ctx.fill(); }
  else if(style==="ponytail"){ ctx.fillRect(cx-44, top, 88, 22); ctx.fillRect(cx+36, top+10, 14, 40); }
  else if(style==="pixie"){ ctx.fillRect(cx-40, top-2, 80, 18); ctx.clearRect(cx-40, top+12, 80, 10); }
  else if(style==="bob"){ ctx.beginPath(); ctx.arc(cx, top+26, 48, Math.PI, 0); ctx.fill(); }
  else if(style==="long"){ ctx.fillRect(cx-44, top, 88, 70); }
  else if(style==="bun"){ ctx.beginPath(); ctx.arc(cx, top, 16, 0, Math.PI*2); ctx.fill(); ctx.fillRect(cx-44, top+6, 88, 18); }
  else if(style==="braids"){ for(let i=0;i<4;i++){ ctx.fillRect(cx-36+i*18, top, 12, 56); } }
  else { ctx.fillRect(cx-44, top, 88, 22); }
}
function drawExpression(ctx, emotion, cx, cy, eyesColor, scale){
  ctx.save();
  const eyeDx = 12*scale;
  const eyeR = 5*scale;
  ctx.fillStyle = eyesColor;
  if(emotion==='surprised'){
    ctx.beginPath(); ctx.arc(cx-eyeDx, cy, eyeR, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(cx+eyeDx, cy, eyeR, 0, Math.PI*2); ctx.fill();
  }else if(emotion==='sleepy'){
    ctx.fillRect(cx-eyeDx-eyeR, cy-1*scale, eyeR*2, 2*scale);
    ctx.fillRect(cx+eyeDx-eyeR, cy-1*scale, eyeR*2, 2*scale);
  }else if(emotion==='frown'){
    ctx.beginPath(); ctx.ellipse(cx-eyeDx, cy, eyeR+2*scale, eyeR-2*scale, 0, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(cx+eyeDx, cy, eyeR+2*scale, eyeR-2*scale, 0, 0, Math.PI*2); ctx.fill();
  }else{
    ctx.beginPath(); ctx.arc(cx-eyeDx, cy, eyeR, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(cx+eyeDx, cy, eyeR, 0, Math.PI*2); ctx.fill();
  }
  ctx.strokeStyle = '#3b2a1b';
  ctx.lineWidth = 3*scale;
  const mouthY = cy + 16*scale;
  if(emotion==='smile'){
    ctx.beginPath(); ctx.arc(cx, mouthY, 16*scale, 0, Math.PI); ctx.stroke();
  }else if(emotion==='frown'){
    ctx.beginPath(); ctx.arc(cx, mouthY+10*scale, 16*scale, Math.PI, 0); ctx.stroke();
  }else if(emotion==='surprised'){
    ctx.beginPath(); ctx.arc(cx, mouthY+2*scale, 8*scale, 0, Math.PI*2); ctx.stroke();
  }else if(emotion==='sleepy'){
    ctx.beginPath(); ctx.moveTo(cx-10*scale, mouthY); ctx.lineTo(cx+10*scale, mouthY); ctx.stroke();
  }else{
    ctx.beginPath(); ctx.moveTo(cx-12*scale, mouthY); ctx.lineTo(cx+12*scale, mouthY); ctx.stroke();
  }
  ctx.restore();
}
function redrawPreview(){
  pctx.clearRect(0,0,pv.width,pv.height);
  const cx=pv.width/2, top=84;
  drawShadow(pctx, cx, pv.height-38);
  const gradient = pctx.createLinearGradient(cx, top-54, cx, top+122);
  gradient.addColorStop(0, state.skin);
  gradient.addColorStop(1, '#c78d5b');
  pctx.fillStyle=gradient;
  pctx.beginPath(); pctx.arc(cx, top-18, 36, 0, Math.PI*2); pctx.fill();
  pctx.fillRect(cx-26, top+12, 52, 96);
  drawExpression(pctx, state.emotion, cx, top-18, state.eyes, 1);
  drawHair(pctx, state.style, state.hair, cx, top-42);
}
makeSwatches('skin-sw', SKINS, 'skin');
makeSwatches('eyes-sw', EYES, 'eyes');
makeSwatches('hair-sw', HAIRS, 'hair');
makeStyles();
makeEmotions();
redrawPreview();

// Submit
async function doRegister(){
  const u=document.getElementById('r-username').value.trim();
  const p=document.getElementById('r-password').value;
  document.getElementById('r-u-err').textContent = validateUser(u)?'':'–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞';
  document.getElementById('r-p-err').textContent = validatePass(p)?'':'–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';
  if(!validateUser(u)||!validatePass(p)) return;

  // if other ‚Äî –Ω–µ–±–æ–ª—å—à–∞—è —Ä–∞–Ω–¥–æ–º–∏–∑–∞—Ü–∏—è –≤ —Ä–∞–º–∫–∞—Ö –ø–∞–ª–∏—Ç—Ä—ã
  let g=genderValue();
  const st=state;
  if(g==='other'){
    st.skin = SKINS[Math.floor(Math.random()*SKINS.length)];
    st.hair = HAIRS[Math.floor(Math.random()*HAIRS.length)];
    st.eyes = EYES[Math.floor(Math.random()*EYES.length)];
    const list=STYLES.other; st.style=list[Math.floor(Math.random()*list.length)];
    const emo=EMOTIONS[Math.floor(Math.random()*EMOTIONS.length)]; st.emotion=emo.value;
    makeSwatches('skin-sw', SKINS, 'skin');
    makeSwatches('eyes-sw', EYES, 'eyes');
    makeSwatches('hair-sw', HAIRS, 'hair');
    makeStyles();
    makeEmotions();
    redrawPreview();
  }

  const f=new FormData();
  f.append('username', u);
  f.append('password', p);
  f.append('gender', g);
  f.append('skin', st.skin);
  f.append('hair', st.hair);
  f.append('eyes', st.eyes);
  f.append('style', st.style);
  f.append('emotion', st.emotion);

  const j=await (await fetch('/api/register',{method:'POST',body:f})).json();
  if(!j.ok){ document.getElementById('err').textContent=j.error||'–û—à–∏–±–∫–∞'; return; }
  localStorage.setItem('cp_username', j.username);
  localStorage.setItem('cp_gender', j.gender||'other');
  localStorage.setItem('cp_appearance', JSON.stringify(j.appearance||state));
  try{
    const a=new FormData(); a.append('username', j.username);
    a.append('skin', state.skin); a.append('hair', state.hair); a.append('eyes', state.eyes); a.append('style', state.style);
    a.append('emotion', state.emotion);
    await fetch('/api/appearance/save',{method:'POST', body:a});
  }catch(e){}
  location.href='/?username='+encodeURIComponent(j.username);
}

// Login
async function doLogin(){
  const u=document.getElementById('l-username').value.trim();
  const p=document.getElementById('l-password').value;
  document.getElementById('l-u-err').textContent = validateUser(u)?'':'–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞';
  document.getElementById('l-p-err').textContent = validatePass(p)?'':'–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';
  if(!validateUser(u)||!validatePass(p)) return;

  const f=new FormData(); f.append('username',u); f.append('password',p);
  const j=await (await fetch('/api/login',{method:'POST',body:f})).json();
  if(!j.ok){ document.getElementById('err').textContent=j.error||'–û—à–∏–±–∫–∞'; return; }
  localStorage.setItem('cp_username', j.username);
  localStorage.setItem('cp_gender', j.gender||'other');
  localStorage.setItem('cp_appearance', JSON.stringify(j.appearance||state));
  try{
    const a=new FormData(); a.append('username', j.username);
    a.append('skin', state.skin); a.append('hair', state.hair); a.append('eyes', state.eyes); a.append('style', state.style);
    a.append('emotion', state.emotion);
    await fetch('/api/appearance/save',{method:'POST', body:a});
  }catch(e){}
  location.href='/?username='+encodeURIComponent(j.username);
}

document.getElementById('btn-register').addEventListener('click', doRegister);
document.getElementById('btn-login').addEventListener('click', doLogin);

// auto-select tab from URL
(function(){ 
  const params=new URLSearchParams(location.search);
  const mode=params.get('mode');
  if(mode==='login'){ switchTab('login'); } else { switchTab('register'); }
})();
</script>
</body>
</html>
