<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Äî –ö–ü</title>
  <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body class="auth-body">
  <div class="auth-card modern big">
    <div class="logo">üîÆ</div>
    <h1>–ö–æ–ª–ª–µ–∫—Ç–∏–≤–Ω–æ–µ –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ</h1>
    <p class="muted">–°–æ–∑–¥–∞–π—Ç–µ –≥–µ—Ä–æ—è ‚Äî –∏ —Å—Ä–∞–∑—É –≤ –ª–æ–∫–∞—Ü–∏—é</p>

    <div class="tabs">
      <button class="tab" data-tab="login">–í—Ö–æ–¥</button>
      <button class="tab active" data-tab="register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>

    <!-- LOGIN -->
    <div class="panel" id="panel-login">
      <div class="row">
        <label class="lbl">–ò–º—è –∏–≥—Ä–æ–∫–∞</label>
        <input id="l-username" placeholder="–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞" autocomplete="username">
        <div class="hint" id="l-u-err"></div>
      </div>
      <div class="row pw">
        <label class="lbl">–ü–∞—Ä–æ–ª—å</label>
        <div class="pw-wrap">
          <input id="l-password" type="password" placeholder="–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" autocomplete="current-password">
          <button class="pw-eye" type="button" data-for="l-password">üëÅ</button>
        </div>
        <div class="hint" id="l-p-err"></div>
      </div>
      <div class="actions">
        <button id="btn-login" class="primary">–í–æ–π—Ç–∏</button>
      </div>
    </div>

    <!-- REGISTER with curated palettes & hairstyles -->
    <div class="panel active" id="panel-register">
      <div class="creator">
        <div class="creator-left">
          <div class="row gender-select-row">
            <div class="hint-row">
              <label class="lbl" for="gender-select">–ü–æ–ª</label>
              <span class="small-muted">–≤–ª–∏—è–µ—Ç –Ω–∞ —Å–∏–ª—É—ç—Ç –∏ —Å—Ç–∏–ª—å</span>
            </div>
            <div class="select-wrap">
              <select id="gender-select" class="pill-select">
                <option value="male">–ú—É–∂—Å–∫–æ–π</option>
                <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
                <option value="other" selected>–ù–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="hint-row">
              <label class="lbl">–¶–≤–µ—Ç –∫–æ–∂–∏</label>
              <span class="small-muted">–Ω–∞—Ç—É—Ä–∞–ª—å–Ω–∞—è –ø–∞–ª–∏—Ç—Ä–∞</span>
            </div>
            <div id="skin-sw" class="swatch-row"></div>
          </div>

          <div class="row">
            <div class="hint-row">
              <label class="lbl">–¶–≤–µ—Ç –≥–ª–∞–∑</label>
              <span class="small-muted">—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏</span>
            </div>
            <div id="eyes-sw" class="swatch-row"></div>
          </div>

          <div class="row">
            <div class="hint-row">
              <label class="lbl">–¶–≤–µ—Ç –≤–æ–ª–æ—Å</label>
              <span class="small-muted">–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞</span>
            </div>
            <div id="hair-sw" class="swatch-row"></div>
          </div>

          <div class="row">
            <label class="lbl">–ü—Ä–∏—á—ë—Å–∫–∞</label>
            <div id="styles-wrap" class="select-inline"></div>
          </div>

          <div class="row">
            <div class="hint-row">
              <label class="lbl">–≠–º–æ—Ü–∏—è</label>
              <span class="small-muted">—Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</span>
            </div>
            <div id="emotion-sw" class="emotion-row"></div>
          </div>

          <div class="row grid2">
            <div>
              <label class="lbl">–ò–º—è –∏–≥—Ä–æ–∫–∞</label>
              <input id="r-username" placeholder="–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞" autocomplete="username">
              <div class="hint" id="r-u-err"></div>
            </div>
            <div class="pw">
              <label class="lbl">–ü–∞—Ä–æ–ª—å</label>
              <div class="pw-wrap">
                <input id="r-password" type="password" placeholder="–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" autocomplete="new-password">
                <button class="pw-eye" type="button" data-for="r-password">üëÅ</button>
              </div>
              <div class="hint" id="r-p-err"></div>
            </div>
          </div>

          <div class="actions">
            <button id="btn-register" class="primary">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
          </div>
        </div>

        <div class="creator-right">
          <canvas id="preview" width="260" height="260"></canvas>
          <div class="muted small">–ü—Ä–µ–≤—å—é –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</div>
        </div>
      </div>
    </div>

    <p id="err" class="error"></p>
  </div>

<script src="/static/js/avatar_drawing.js"></script>
<script>
// Helpers
async function api(url, method="GET", body=null){
  const opt={method};
  if(body instanceof FormData){ opt.body=body; }
  else if(body){ opt.headers={"Content-Type":"application/json"}; opt.body=JSON.stringify(body); }
  const r=await fetch(url,opt); return r.json();
}
function switchTab(id){
  document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
  document.querySelectorAll('.panel').forEach(p=>p.classList.toggle('active', p.id==='panel-'+id));
  document.getElementById('err').textContent='';
}
document.querySelectorAll('.tab').forEach(b=>b.addEventListener('click',()=>switchTab(b.dataset.tab)));
document.querySelectorAll('.pw-eye').forEach(btn=>btn.addEventListener('click',()=>{
  const id=btn.getAttribute('data-for'); const el=document.getElementById(id);
  el.type = (el.type==='password'?'text':'password');
}));

function genderValue(){ const el=document.getElementById('gender-select'); return el?el.value||'other':'other'; }
function validateUser(name){ return (name||'').trim().length>=3; }
function validatePass(p){ return (p||'').length>=6; }

// Palettes
const SKINS=['#f7d7ba','#f1c7a3','#d39a70','#bb8656','#9c613f'];
const EYES=['#2b4c7e','#5c3b8c','#2f6b3c','#1e1e1e','#6b3f2f'];
const HAIRS=['#1e1e1e','#3a2a1c','#6b4f2f','#a37d58','#c9a873','#df8e44'];
const EMOTIONS=[
  {value:'smile',label:'–£–ª—ã–±–∫–∞',icon:'üôÇ'},
  {value:'neutral',label:'–°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ',icon:'üòê'},
  {value:'frown',label:'–°–µ—Ä—å—ë–∑–Ω—ã–π',icon:'üò†'},
  {value:'surprised',label:'–£–¥–∏–≤–ª–µ–Ω–∏–µ',icon:'üòØ'},
  {value:'sleepy',label:'–°–æ–Ω–Ω—ã–π',icon:'üò¥'}
];
const GENDER_OUTFITS={
  male:{primary:'#3a6ea5',secondary:'#2e4f79',accent:'#1f2f57'},
  female:{primary:'#f19ad9',secondary:'#d16ec7',accent:'#ffd6ef'},
  other:{primary:'#4c8fca',secondary:'#3a6aa3',accent:'#9fd9ff'}
};

// Hairstyles catalog by gender
const STYLES = {
  male: ["short","fade","buzz","undercut","mohawk","curly","afro","ponytail"],
  female: ["pixie","bob","long","curly","bun","braids","afro","ponytail"],
  other: ["short","pixie","bob","long","curly","afro","braids","mohawk","ponytail"]
};

// State
let state = {
  skin: SKINS[1],
  hair: HAIRS[0],
  eyes: EYES[0],
  style: "short",
  emotion: "smile"
};
let appearanceLoaded = false;
try{
  const stored=JSON.parse(localStorage.getItem('cp_appearance')||'{}');
  if(stored.skin && SKINS.includes(stored.skin)){ state.skin=stored.skin; appearanceLoaded=true; }
  if(stored.hair && HAIRS.includes(stored.hair)){ state.hair=stored.hair; appearanceLoaded=true; }
  if(stored.eyes && EYES.includes(stored.eyes)){ state.eyes=stored.eyes; appearanceLoaded=true; }
  if(stored.style && Object.values(STYLES).some(list=>list.includes(stored.style))){ state.style=stored.style; appearanceLoaded=true; }
  if(stored.emotion && EMOTIONS.some(e=>e.value===stored.emotion)){ state.emotion=stored.emotion; appearanceLoaded=true; }
}catch(e){}

function randomizeAppearanceFor(g){
  const genderKey = g||'other';
  state.skin = SKINS[Math.floor(Math.random()*SKINS.length)];
  state.hair = HAIRS[Math.floor(Math.random()*HAIRS.length)];
  state.eyes = EYES[Math.floor(Math.random()*EYES.length)];
  const list = STYLES[genderKey] || STYLES.other;
  state.style = list[Math.floor(Math.random()*list.length)];
  const emo = EMOTIONS[Math.floor(Math.random()*EMOTIONS.length)];
  state.emotion = emo.value;
}

if(!appearanceLoaded && genderValue()==='other'){
  randomizeAppearanceFor('other');
}

// Build swatches
function makeSwatches(id, arr, cls){
  const box=document.getElementById(id); box.innerHTML="";
  const current = id==='skin-sw'?state.skin:(id==='eyes-sw'?state.eyes:state.hair);
  let selectedEl=null;
  arr.forEach((val)=>{
    const d=document.createElement('div'); d.className='swatch '+(cls||'');
    d.style.background=val; d.dataset.val=val; d.dataset.selected=0;
    d.addEventListener('click',()=>{
      box.querySelectorAll('.swatch').forEach(s=>s.dataset.selected=0);
      d.dataset.selected=1;
      if(id==='skin-sw') state.skin=val;
      if(id==='eyes-sw') state.eyes=val;
      if(id==='hair-sw') state.hair=val;
      redrawPreview();
    });
    if(val===current){ selectedEl=d; }
    box.appendChild(d);
  });
  const target=selectedEl || box.querySelector('.swatch');
  if(target){
    target.dataset.selected=1;
    const val=target.dataset.val;
    if(id==='skin-sw') state.skin=val;
    if(id==='eyes-sw') state.eyes=val;
    if(id==='hair-sw') state.hair=val;
  }
}
function makeStyles(){
  const g=genderValue();
  const list=STYLES[g]||STYLES.other;
  const box=document.getElementById('styles-wrap'); box.innerHTML="";
  const preferred = list.includes(state.style)?state.style:list[0];
  state.style = preferred;
  list.forEach((name)=>{
    const b=document.createElement('button'); b.type='button'; b.className='badge'; b.textContent=hairLabel(name);
    b.dataset.val=name;
    b.addEventListener('click',()=>{
      box.querySelectorAll('.badge').forEach(x=>x.dataset.selected=0);
      b.dataset.selected=1; state.style=name; redrawPreview();
    });
    if(name===preferred) b.dataset.selected=1;
    box.appendChild(b);
  });
}
function updateEmotionScrollMask(box){
  if(!box) return;
  const width=box.clientWidth;
  if(width<=0){
    box.dataset.scrollLeft='0';
    box.dataset.scrollRight='0';
    return;
  }
  const maxScroll=Math.max(0, box.scrollWidth-width);
  if(maxScroll<=1){
    box.dataset.scrollLeft='0';
    box.dataset.scrollRight='0';
    return;
  }
  box.dataset.scrollLeft=box.scrollLeft>1?'1':'0';
  box.dataset.scrollRight=box.scrollLeft<maxScroll-1?'1':'0';
}
function centerEmotionInRow(box){
  if(!box) return;
  const width=box.clientWidth;
  if(width<=0){ updateEmotionScrollMask(box); return; }
  const selected=box.querySelector('.emotion-btn[data-selected="1"]');
  const maxScroll=Math.max(0, box.scrollWidth-width);
  if(selected){
    const target=selected.offsetLeft-(width-selected.offsetWidth)/2;
    box.scrollLeft=Math.max(0, Math.min(maxScroll, target));
  }
  updateEmotionScrollMask(box);
}
function attachEmotionScroll(box){
  if(!box) return;
  if(!box.dataset.scrollHook){
    box.addEventListener('scroll',()=>updateEmotionScrollMask(box),{passive:true});
    box.dataset.scrollHook='1';
  }
  requestAnimationFrame(()=>centerEmotionInRow(box));
}
function makeEmotions(){
  const box=document.getElementById('emotion-sw'); if(!box) return;
  box.innerHTML="";
  box.dataset.scrollLeft='0';
  box.dataset.scrollRight='0';
  const current=state.emotion;
  EMOTIONS.forEach(em=>{
    const btn=document.createElement('button');
    btn.type='button';
    btn.className='emotion-btn';
    btn.innerHTML=`<span class="emo-icon">${em.icon}</span><span>${em.label}</span>`;
    btn.dataset.val=em.value;
    btn.addEventListener('click',()=>{
      state.emotion=em.value;
      box.querySelectorAll('.emotion-btn').forEach(b=>b.dataset.selected=0);
      btn.dataset.selected=1;
      redrawPreview();
      centerEmotionInRow(box);
    });
    if(em.value===current) btn.dataset.selected=1;
    box.appendChild(btn);
  });
  attachEmotionScroll(box);
}
const genderSelect=document.getElementById('gender-select');
if(genderSelect){
  try{
    const storedGender=localStorage.getItem('cp_gender');
    if(storedGender && [...genderSelect.options].some(opt=>opt.value===storedGender)){
      genderSelect.value=storedGender;
    }
  }catch(e){}
  genderSelect.addEventListener('change',()=>{
    makeStyles();
    makeEmotions();
    redrawPreview();
  });
}

// Preview drawing
const pv=document.getElementById('preview'), pctx=pv.getContext('2d');
const { drawHead, drawHair, drawExpression } = window.AvatarDrawing || {};
function drawShadow(ctx, cx, cy){
  ctx.save();
  ctx.fillStyle='rgba(12,16,32,0.32)';
  ctx.beginPath();
  ctx.ellipse(cx, cy, 88, 22, 0, 0, Math.PI*2);
  ctx.fill();
  ctx.restore();
}
function hairLabel(style){
  const map={short:"–ö–æ—Ä–æ—Ç–∫–∞—è",fade:"–§–µ–π–¥",buzz:"–Å–∂–∏–∫",undercut:"–ê–Ω–¥–µ—Ä–∫–∞—Ç",mohawk:"–ò—Ä–æ–∫–µ–∑",
             curly:"–ö—É–¥—Ä–∏",afro:"–ê—Ñ—Ä–æ",ponytail:"–•–≤–æ—Å—Ç",pixie:"–ü–∏–∫—Å–∏",bob:"–ö–∞—Ä–µ",long:"–î–ª–∏–Ω–Ω—ã–µ",
             bun:"–ü—É—á–æ–∫",braids:"–ö–æ—Å—ã"};
  return map[style]||style;
}
function redrawPreview(){
  if(!(drawHead && drawHair && drawExpression)) return;
  pctx.clearRect(0,0,pv.width,pv.height);
  const cx=pv.width/2, top=84;
  drawShadow(pctx, cx, pv.height-38);
  const gender=genderValue();
  const outfit=GENDER_OUTFITS[gender]||GENDER_OUTFITS.other;

  const headRadius = 36;
  const headCy = top - 18;
  const previewFaceScale = headRadius / 36;
  drawHead(pctx, cx, headCy, headRadius, state.skin);

  const bodyTop = top+12;
  const bodyHeight = gender==='female'?90:96;
  const bodyWidth = gender==='female'?48:52;
  const half=bodyWidth/2;
  const bodyGradient = pctx.createLinearGradient(cx, bodyTop, cx, bodyTop+bodyHeight);
  bodyGradient.addColorStop(0, state.skin);
  bodyGradient.addColorStop(1, '#c78d5b');
  pctx.fillStyle=bodyGradient;
  pctx.beginPath();
  if(gender==='female'){
    pctx.moveTo(cx-half*0.95, bodyTop+20);
    pctx.quadraticCurveTo(cx, bodyTop-8, cx+half*0.95, bodyTop+20);
    pctx.lineTo(cx+half*0.7, bodyTop+bodyHeight-6);
    pctx.lineTo(cx-half*0.7, bodyTop+bodyHeight-6);
    pctx.closePath();
  }else{
    pctx.rect(cx-half, bodyTop, bodyWidth, bodyHeight);
  }
  pctx.fill();

  if(gender==='female'){
    const dressGrad = pctx.createLinearGradient(cx, bodyTop+8, cx, bodyTop+bodyHeight-4);
    dressGrad.addColorStop(0, outfit.primary);
    dressGrad.addColorStop(1, outfit.secondary);
    pctx.fillStyle=dressGrad;
    pctx.beginPath();
    pctx.moveTo(cx-half*0.92, bodyTop+24);
    pctx.quadraticCurveTo(cx, bodyTop+bodyHeight*0.32, cx+half*0.92, bodyTop+24);
    pctx.lineTo(cx+half*0.68, bodyTop+bodyHeight-10);
    pctx.lineTo(cx-half*0.68, bodyTop+bodyHeight-10);
    pctx.closePath();
    pctx.fill();
    pctx.fillStyle=outfit.accent;
    const beltWidth=bodyWidth*0.9;
    pctx.fillRect(cx-beltWidth/2, bodyTop+bodyHeight*0.48, beltWidth, 6);
    pctx.fillStyle=outfit.primary;
    pctx.beginPath();
    pctx.ellipse(cx-half*0.88, bodyTop+34, 9, 14, 0, 0, Math.PI*2);
    pctx.ellipse(cx+half*0.88, bodyTop+34, 9, 14, 0, 0, Math.PI*2);
    pctx.fill();
  }else{
    pctx.fillStyle=outfit.primary;
    pctx.fillRect(cx-half, bodyTop+8, bodyWidth, bodyHeight*0.62);
    pctx.fillStyle=outfit.secondary;
    pctx.fillRect(cx-half+6, bodyTop+bodyHeight*0.62, bodyWidth-12, bodyHeight*0.38);
    pctx.fillStyle=outfit.accent;
    pctx.fillRect(cx-half, bodyTop+bodyHeight*0.62-6, bodyWidth, 6);
  }

  drawExpression(pctx, state.emotion, cx, headCy, state.eyes, previewFaceScale);
  const hairTop = headCy - (headRadius * 0.7);
  drawHair(pctx, state.style, state.hair, cx, hairTop, previewFaceScale);
}
makeSwatches('skin-sw', SKINS, 'skin');
makeSwatches('eyes-sw', EYES, 'eyes');
makeSwatches('hair-sw', HAIRS, 'hair');
makeStyles();
makeEmotions();
redrawPreview();

// Submit
async function doRegister(){
  const u=document.getElementById('r-username').value.trim();
  const p=document.getElementById('r-password').value;
  document.getElementById('r-u-err').textContent = validateUser(u)?'':'–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞';
  document.getElementById('r-p-err').textContent = validatePass(p)?'':'–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';
  if(!validateUser(u)||!validatePass(p)) return;

  let g=genderValue();
  const st=state;

  const f=new FormData();
  f.append('username', u);
  f.append('password', p);
  f.append('gender', g);
  f.append('skin', st.skin);
  f.append('hair', st.hair);
  f.append('eyes', st.eyes);
  f.append('style', st.style);
  f.append('emotion', st.emotion);

  const j=await (await fetch('/api/register',{method:'POST',body:f})).json();
  if(!j.ok){ document.getElementById('err').textContent=j.error||'–û—à–∏–±–∫–∞'; return; }
  localStorage.setItem('cp_username', j.username);
  localStorage.setItem('cp_gender', j.gender||'other');
  localStorage.setItem('cp_appearance', JSON.stringify(j.appearance||state));
  try{
    const a=new FormData(); a.append('username', j.username);
    a.append('skin', state.skin); a.append('hair', state.hair); a.append('eyes', state.eyes); a.append('style', state.style);
    a.append('emotion', state.emotion);
    await fetch('/api/appearance/save',{method:'POST', body:a});
  }catch(e){}
  location.href='/?username='+encodeURIComponent(j.username);
}

// Login
async function doLogin(){
  const u=document.getElementById('l-username').value.trim();
  const p=document.getElementById('l-password').value;
  document.getElementById('l-u-err').textContent = validateUser(u)?'':'–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞';
  document.getElementById('l-p-err').textContent = validatePass(p)?'':'–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';
  if(!validateUser(u)||!validatePass(p)) return;

  const f=new FormData(); f.append('username',u); f.append('password',p);
  const j=await (await fetch('/api/login',{method:'POST',body:f})).json();
  if(!j.ok){ document.getElementById('err').textContent=j.error||'–û—à–∏–±–∫–∞'; return; }
  localStorage.setItem('cp_username', j.username);
  localStorage.setItem('cp_gender', j.gender||'other');
  localStorage.setItem('cp_appearance', JSON.stringify(j.appearance||state));
  try{
    const a=new FormData(); a.append('username', j.username);
    a.append('skin', state.skin); a.append('hair', state.hair); a.append('eyes', state.eyes); a.append('style', state.style);
    a.append('emotion', state.emotion);
    await fetch('/api/appearance/save',{method:'POST', body:a});
  }catch(e){}
  location.href='/?username='+encodeURIComponent(j.username);
}

document.getElementById('btn-register').addEventListener('click', doRegister);
document.getElementById('btn-login').addEventListener('click', doLogin);

// auto-select tab from URL
(function(){ 
  const params=new URLSearchParams(location.search);
  const mode=params.get('mode');
  if(mode==='login'){ switchTab('login'); } else { switchTab('register'); }
})();
</script>
</body>
</html>
